trigger:
  branches:
    include:
      - main
      - develop
      - development

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: Build
    displayName: 'ğŸ—ï¸ Build'
    jobs:
      - job: BuildJob
        displayName: 'âš™ï¸ Build and Test'
        steps:
          - task: NodeTool@0
            displayName: 'ğŸ“¦ Install Node.js'
            inputs:
              versionSpec: '24.x'

          - script: npm install -g pnpm
            displayName: 'ğŸ“¦ Install pnpm'

          - task: Cache@2
            displayName: 'ğŸ’¾ Cache node_modules'
            inputs:
              key: 'pnpm | "$(Agent.OS)" | pnpm-lock.yaml'
              path: node_modules
              restoreKeys: |
                pnpm | "$(Agent.OS)"

          - script: pnpm i
            displayName: 'ğŸ“¥ Install dependencies'

          - script: pnpm build
            displayName: 'ğŸ”¨ Build Vite project'

          - task: PublishBuildArtifacts@1
            displayName: 'ğŸ“¤ Publish build artifacts'
            inputs:
              PathtoPublish: 'dist'
              ArtifactName: 'app'
              publishLocation: 'Container'

  - stage: Deploy
    displayName: 'ğŸš€ Deploy'
    dependsOn: Build
    condition: and(succeeded(), startsWith(variables['Build.SourceBranch'], 'refs/tags/'))
    variables:
      - name: MFE_ORCHESTRATOR_SECRETS
      - name: VERSION
        value: $[replace(variables['Build.SourceBranch'], 'refs/tags/', '')]
    jobs:
      - job: Deploy
        displayName: 'ğŸ“¦ Upload Microfrontend'
        steps:
          - task: DownloadBuildArtifacts@1
            displayName: 'ğŸ“¥ Download build artifacts'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'app'
              downloadPath: '$(System.ArtifactsDirectory)'

          - task: mfe-orchestrator-upload@1
            displayName: 'ğŸš€ Upload to MFE Orchestrator'
            inputs:
              apiKey: $MICROFRONTEND_ORCHESTRATOR_API_KEY
              microfrontendSlug: '%microfrontendSlug%'
              filePath: '$(System.ArtifactsDirectory)/app'
              version: '$(VERSION)'