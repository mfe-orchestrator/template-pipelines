trigger:
  branches:
    include:
      - main
      - develop
      - development

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: Build
    displayName: 'ðŸ—ï¸ Build Vite.js Application'
    jobs:
      - job: BuildJob
        displayName: 'âš™ï¸ Build and Test'
        steps:
          - checkout: self
            fetchDepth: '0'

          - script: |
              set -e
              # Determine version from Git tag if available
              if [[ "${BUILD_SOURCEBRANCH}" == refs/tags/* ]]; then
                VERSION="${BUILD_SOURCEBRANCHNAME}"
              else
                # Ensure tags are fetched and try to get latest tag reachable from HEAD
                git fetch --tags --force
                if VERSION=$(git describe --tags --abbrev=0 2>/dev/null); then
                  :
                else
                  VERSION="${BUILD_BUILDNUMBER}"
                fi
              fi
              echo "Using version: $VERSION"
              echo "##vso[task.setvariable variable=PackageVersion]$VERSION"
            displayName: 'ðŸ”– Resolve version from Git tag'

          - task: NodeTool@0
            displayName: 'ðŸ“¦ Install Node.js'
            inputs:
              versionSpec: '24.x'

          - script: npm install -g pnpm
            displayName: 'ðŸ“¦ Install pnpm'

          - task: Cache@2
            displayName: 'ðŸ’¾ Cache node_modules'
            inputs:
              key: 'pnpm | "$(Agent.OS)" | pnpm-lock.yaml'
              path: node_modules
              restoreKeys: |
                pnpm | "$(Agent.OS)"

          - script: pnpm i
            displayName: 'ðŸ“¥ Install dependencies'

          - script: pnpm build
            displayName: 'ðŸ”¨ Build Vite project'

          - task: PublishBuildArtifacts@1
            displayName: 'ðŸ“¤ Publish build artifacts'
            inputs:
              PathtoPublish: 'dist'
              ArtifactName: 'vite-app'
              publishLocation: 'Container'

          - task: mfe-orchestrator-upload@1
            displayName: 'ðŸš€ Publish to MFE Orchestrator'
            inputs:
              apiKey: $(MICROFRONTEND_ORCHESTRATOR_API_KEY)
              microfrontendSlug: '%microfrontendSlug%'
              filePath: '$(Build.ArtifactStagingDirectory)/dist'
              version: '$(PackageVersion)'
              domain: '%domain%'