trigger:
  branches:
    include:
      - main
      - develop
      - development

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: BuildAndDeploy
    displayName: 'ğŸ—ï¸ Build & Deploy'
    jobs:
      - job: BuildJob
        displayName: 'âš™ï¸ Build Vite Application'
        steps:
          - task: NodeTool@0
            displayName: 'ğŸ“¦ Install Node.js'
            inputs:
              versionSpec: '24.x'

          - script: npm install -g pnpm
            displayName: 'ğŸ“¦ Install pnpm'

          - task: Cache@2
            displayName: 'ğŸ’¾ Cache node_modules'
            inputs:
              key: 'pnpm | "$(Agent.OS)" | pnpm-lock.yaml'
              path: node_modules
              restoreKeys: |
                pnpm | "$(Agent.OS)"

          - script: pnpm i
            displayName: 'ğŸ“¥ Install dependencies'

          - script: pnpm build
            displayName: 'ğŸ”¨ Build project'

          - publish: $(System.DefaultWorkingDirectory)/dist
            artifact: app-source
            displayName: 'ğŸ“¦ Publish artifacts for Docker build'

      - job: DeployJob
        displayName: 'ğŸ³ Docker Build & Push'
        dependsOn: BuildJob
        variables:
          - name: imageName
            value: ${{ coalesce(variables['imageName'], variables['Build.Repository.Name']) }}
        steps:
          - task: DownloadBuildArtifacts@1
            displayName: 'ğŸ“¥ Download build artifacts'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: 'app-source'
              downloadPath: '$(System.ArtifactsDirectory)/dist'
          
          - task: Docker@2
            displayName: 'ğŸ”‘ Login to Container Registry'
            inputs:
              containerRegistry: '$(CONTAINER_REGISTRY)'
              command: 'login'

          - script: |
              docker pull $(CONTAINER_REPOSITORY)/$(imageName):latest || echo "Latest image does not exist"
              docker pull $(CONTAINER_REPOSITORY)/$(imageName):dev || echo "dev image does not exist"
            displayName: 'â¬‡ï¸ Pull images'

          - task: Docker@2
            condition: eq(variables.isTag,true)
            displayName: 'ğŸ³ Build & Push Docker Image (Tag)'
            inputs:
              containerRegistry: '$(CONTAINER_REGISTRY)'
              repository: '$(imageName)'
              command: 'buildAndPush'
              Dockerfile: '**/Dockerfile'
              tags: '$(tagName),latest'
              platform: 'linux/amd64,linux/arm64'

          
          - task: Docker@2
            condition: eq(variables.isCdCiBranch,true)  
            displayName: 'ğŸ³ Build & Push Docker Image (DEV)'
            inputs:
              containerRegistry: '$(CONTAINER_REGISTRY)'
              repository: '$(imageName)'
              command: 'buildAndPush'
              Dockerfile: '**/Dockerfile'
              tags: 'dev'
              platform: 'linux/amd64,linux/arm64'

        
          - script: docker system prune -a --force
            displayName: 'âŒ Prune images'

